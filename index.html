// streaming.js - FULL file (complete & smart)
//
// Keeps original features: carousel, categories, history, settings, stealth, dark mode.
// Adds tabs (Movies / TV) and a single API toggle to choose between ORIGINAL_PLAYER (your custom player) and embed.su.
// Lists and search use TMDB by default; when embed toggle is on, lists come from embed.su list endpoints and clicking plays embed.su embeds.
// TV season/episode metadata always pulled from TMDB so the modal works for picking episodes (then opens embed.su or original player as chosen).

// -------------------- DOM references --------------------
const bigDiv = document.getElementById("bigDiv");
const searchBar = document.getElementById("searchbar");
const iframeContainer = document.getElementById("iframeContainer");
const fullscreenIframe = document.getElementById("fullscreenIframe");
const iframeTitleMain = document.getElementById("iframeTitleMain");

// TV modal
const tvModal = document.getElementById("tvModal");
const tvModalTitle = document.getElementById("tvModalTitle");
const seasonList = document.getElementById("seasonList");
const episodeList = document.getElementById("episodeList");

// History & UI
const historyDiv = document.getElementById("historyDiv");
const categoriesDiv = document.getElementById("categories");
const carouselTrack = document.querySelector(".carousel-track");
const carousel = document.getElementById("carousel");
const moviesTab = document.getElementById("moviesTab");
const tvTab = document.getElementById("tvTab");
const apiToggleEl = document.getElementById("apiToggle");
const settingsButton = document.getElementById("settingsButton");
const settingsModal = document.getElementById("settingsModal");
const stealthToggle = document.getElementById("stealthToggle");
const darkToggle = document.getElementById("darkToggle");
const notifToggle = document.getElementById("notifToggle");
const darkLabel = document.getElementById("darkLabel");

// -------------------- Config --------------------
const STEALTH_KEY = "streaming_hub_stealth";
const HISTORY_KEY = "streaming_hub_history";
const apiKey = "9a2954cb0084e80efa20b3729db69067";
const tmdbUrl = "https://api.themoviedb.org/3";

// ORIGINAL PLAYER base used when embed toggle is OFF (you can change this easily)
const ORIGINAL_PLAYER_BASE = "https://stuffgoogle.vercel.app/W/customsource?id={id}&type={type}";

// Toggle: when true -> use embed.su lists and embed.su embeds, when false -> use TMDB lists and ORIGINAL_PLAYER_BASE for movies.
let useEmbedAPI = false;

// Tabs
let activeTab = "movies"; // "movies" or "tv"

// Carousel state
let carouselIndex = 0;
let carouselItems = [];

// -------------------- Helpers --------------------
const fetchAPI = async (url) => {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.json();
  } catch (err) {
    console.error("fetchAPI error:", err);
    return null;
  }
};

// Build original player URL easily
function buildOriginalPlayerUrl(id, type = "movie") {
  return ORIGINAL_PLAYER_BASE.replace("{id}", encodeURIComponent(id)).replace("{type}", encodeURIComponent(type));
}

// Generate the player/embed URL depending on toggle and type
const generatePlayerUrl = (id, type, season = null, episode = null) => {
  // If embed mode -> use embed.su endpoints (they accept TMDB or IMDB ids per your note)
  if (useEmbedAPI) {
    if (type === "movie") return `https://embed.su/embed/movie/${id}`;
    if (type === "tv" && season !== null && episode !== null) return `https://embed.su/embed/tv/${id}/${season}/${episode}`;
    // fallback for tv if season/episode missing:
    if (type === "tv") return `https://embed.su/embed/tv/${id}/1/1`;
  } else {
    // Not embed mode: prefer your original player for movies, for tv we rely on TMDB modal to craft a proper URL (or use original player)
    if (type === "movie") return buildOriginalPlayerUrl(id, "movie");
    if (type === "tv") {
      // If season/episode provided, we attempt to use embed-style endpoint on your original player if supported,
      // otherwise fall back to TMDB season endpoint (useful for debug). We'll just point to ORIGINAL_PLAYER_BASE and include season/episode in the title.
      if (season !== null && episode !== null) return buildOriginalPlayerUrl(id, `tv&season=${season}&episode=${episode}`);
      return buildOriginalPlayerUrl(id, "tv");
    }
  }
  return "";
};

// -------------------- History --------------------
function saveHistory(title, url, poster, rating = "N/A", media_type = "movie") {
  let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  history = history.filter(h => h.title !== title);
  history.unshift({ title, url, poster, rating, media_type, time: Date.now() });
  if (history.length > 50) history.pop();
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
  historyDiv.innerHTML = "";
  history.forEach(item => {
    const card = document.createElement("div");
    card.className = "group relative rounded-2xl overflow-hidden bg-white/5 border border-white/10 shadow-lg hover:shadow-blue-500/30 transition transform hover:-translate-y-2 hover:scale-105 cursor-pointer";
    card.innerHTML = `
      <div class="overflow-hidden relative">
        <img src="${item.poster || ''}" class="w-full h-72 object-cover group-hover:scale-110 transition duration-500" alt="${item.title}">
        <div class="absolute top-2 right-2 rating">${item.rating}</div>
      </div>
      <div class="card-footer">
        <h3 class="card-title text-white font-semibold text-sm truncate max-w-[70%]">${item.title}</h3>
      </div>
    `;
    card.addEventListener("click", () => openIframe(item.url, item.title));
    historyDiv.appendChild(card);
  });
}

// -------------------- Carousel --------------------
function renderCarousel(items) {
  carouselItems = items || [];
  carouselTrack.innerHTML = "";
  carouselItems.forEach(i => {
    // support TMDB item poster_path or embed.su 'poster' full path
    const poster = i.poster_path ? `https://image.tmdb.org/t/p/original/${i.poster_path}` : (i.poster || '');
    const slide = document.createElement("div");
    slide.className = "carousel-slide";
    const img = document.createElement("img");
    img.src = poster;
    img.alt = i.title || i.name || '';
    slide.appendChild(img);
    slide.addEventListener("click", () => {
      // On click open player: prefer movie; if tv try first episode
      const type = i.media_type || i.type || (i.first_air_date ? 'tv' : 'movie');
      if (type === 'tv') {
        // open TV modal so user can pick; if embed mode and we don't have TMDB id we fallback to S1E1
        showTVModal(i.id, i.title || i.name);
      } else {
        const url = generatePlayerUrl(i.id, "movie");
        openIframe(url, i.title || i.name);
        saveHistory(i.title || i.name, url, poster, i.vote_average || i.rating || "N/A", "movie");
      }
    });
    carouselTrack.appendChild(slide);
  });
  updateCarousel();
}

function updateCarousel() {
  if (!carouselItems.length) return;
  carouselTrack.style.transform = `translateX(-${carouselIndex * 100}%)`;
}
document.querySelector(".carousel-button.prev").addEventListener("click", () => {
  if (!carouselItems.length) return;
  carouselIndex = (carouselIndex - 1 + carouselItems.length) % carouselItems.length;
  updateCarousel();
});
document.querySelector(".carousel-button.next").addEventListener("click", () => {
  if (!carouselItems.length) return;
  carouselIndex = (carouselIndex + 1) % carouselItems.length;
  updateCarousel();
});

// -------------------- Cards & Display --------------------
const createCard = (item) => {
  // Normalize fields between TMDB and embed.su
  const poster = item.poster_path ? `https://image.tmdb.org/t/p/w500/${item.poster_path}` : (item.poster || '');
  const rating = item.vote_average ? `⭐ ${Math.round(item.vote_average * 10) / 10}` : (item.rating ? `⭐ ${item.rating}` : '');
  const year = item.release_date ? item.release_date.slice(0,4) : (item.first_air_date ? item.first_air_date.slice(0,4) : (item.year || "N/A"));
  const title = item.title || item.name || item.caption || "Untitled";
  const mediaType = item.media_type || item.type || (item.first_air_date ? 'tv' : 'movie');

  const card = document.createElement("div");
  card.className = "result-card";
  card.innerHTML = `
    <div class="poster-container"><img src="${poster}" alt="${title}"></div>
    <div class="card-info">
      <div class="card-title">${title}</div>
      <div class="card-meta"><span>${rating}</span><span>${year}</span></div>
    </div>
  `;

  card.addEventListener("click", () => {
    if (mediaType === "tv") {
      // Show TV modal (metadata always fetched from TMDB so user can pick season/episode)
      showTVModal(item.id, title);
    } else {
      // Movie: pick embed or original player depending on toggle
      const url = generatePlayerUrl(item.id, "movie");
      openIframe(url, title);
      saveHistory(title, url, poster, item.vote_average || item.rating || "N/A", "movie");
    }
  });

  return card;
};

function displayResults(results) {
  bigDiv.innerHTML = results && results.length ? "" : "<p style='text-align:center;color:#9ca3af'>No results found.</p>";
  if (!results || !results.length) return;
  results.forEach(item => {
    // if embed.su items sometimes include null poster_paths; still render if title exists
    if (item.poster_path || item.poster || item.title || item.name) {
      const card = createCard(item);
      bigDiv.appendChild(card);
    }
  });
}

// -------------------- TV Modal (seasons/episodes) --------------------
let currentTV = null;
let currentTitle = null;

async function showTVModal(tvId, title) {
  currentTV = tvId;
  currentTitle = title;
  seasonList.innerHTML = "";
  episodeList.innerHTML = "";
  tvModalTitle.textContent = title || "TV Show";

  tvModal.style.display = "flex";

  // Always use TMDB to fetch seasons & episodes (so modal works even if embed.su is used for playback)
  const url = `${tmdbUrl}/tv/${tvId}?api_key=${apiKey}`;
  const showData = await fetchAPI(url);
  if (!showData) {
    episodeList.innerHTML = "<p>Error fetching show data.</p>";
    return;
  }
  const seasons = (showData.seasons || []).filter(s => s.season_number >= 0);

  // If no seasons returned, show single button to open season 1 episode 1
  if (!seasons.length) {
    const b = document.createElement("button");
    b.textContent = "Play S1E1";
    b.addEventListener("click", () => {
      const url = generatePlayerUrl(tvId, "tv", 1, 1);
      openIframe(url, `${title} - S1E1`);
      saveHistory(`${title} - S1E1`, url, showData.poster_path ? `https://image.tmdb.org/t/p/w500/${showData.poster_path}` : '', showData.vote_average || 'N/A', 'tv');
      closeTVModal();
    });
    episodeList.appendChild(b);
    return;
  }

  seasons.forEach(s => {
    const btn = document.createElement("button");
    btn.textContent = `Season ${s.season_number}`;
    btn.className = "category-btn";
    btn.addEventListener("click", () => loadEpisodes(tvId, s.season_number, btn));
    seasonList.appendChild(btn);
  });

  // Auto-click first season
  if (seasonList.firstChild) {
    seasonList.firstChild.click();
  }
}

async function loadEpisodes(tvId, seasonNumber, activeBtn) {
  Array.from(seasonList.children).forEach(b => b.classList.remove("active"));
  activeBtn.classList.add("active");
  episodeList.innerHTML = "<p>Loading episodes...</p>";

  const url = `${tmdbUrl}/tv/${tvId}/season/${seasonNumber}?api_key=${apiKey}`;
  const seasonData = await fetchAPI(url);
  episodeList.innerHTML = "";

  if (!seasonData || !seasonData.episodes) {
    episodeList.innerHTML = "<p>Error loading episodes.</p>";
    return;
  }

  seasonData.episodes.forEach(ep => {
    const btn = document.createElement("button");
    btn.className = "category-btn";
    btn.textContent = `Episode ${ep.episode_number}: ${ep.name}`;
    btn.addEventListener("click", () => {
      // When user clicks episode -> open embed or original player depending on toggle
      const playerUrl = generatePlayerUrl(tvId, "tv", seasonNumber, ep.episode_number);
      openIframe(playerUrl, `${currentTitle} - S${seasonNumber}E${ep.episode_number}`);
      // try to compute poster if available
      const poster = seasonData.poster_path ? `https://image.tmdb.org/t/p/w500${seasonData.poster_path}` : '';
      saveHistory(`${currentTitle} - S${seasonNumber}E${ep.episode_number}`, playerUrl, poster, ep.vote_average || 'N/A', 'tv');
      closeTVModal();
    });
    episodeList.appendChild(btn);
  });
}

function closeTVModal() {
  tvModal.style.display = "none";
  seasonList.innerHTML = "";
  episodeList.innerHTML = "";
}

// -------------------- Iframe open/close --------------------
function openIframe(url, title = "Now Playing") {
  fullscreenIframe.src = url;
  iframeTitleMain.textContent = title;
  iframeContainer.classList.remove("hidden");
  iframeContainer.style.display = "flex";
}

function closeIframe() {
  fullscreenIframe.src = "";
  iframeContainer.style.display = "none";
  iframeContainer.classList.add("hidden");
}

// -------------------- Categories & Carousel initializers --------------------
const categories = ["Trending", "Top Rated", "Action", "Comedy", "Horror", "Romance", "Documentary"];
categories.forEach(cat => {
  const btn = document.createElement("button");
  btn.className = "category-btn";
  btn.textContent = cat;
  btn.addEventListener("click", () => {
    document.querySelectorAll(".category-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    loadCategory(cat);
  });
  // Append only to the categories container if it's empty placeholders
  if (categoriesDiv) categoriesDiv.appendChild(btn);
});

async function fetchCategoryData(category) {
  // Basic mapping: Trending / Top Rated -> TMDB endpoints; otherwise use discover for movies by "keyword" (best-effort).
  // Keep original API behavior (this was in your prior file).
  let url = "";
  switch (category) {
    case "Trending":
      url = `${tmdbUrl}/trending/all/day?api_key=${apiKey}`;
      break;
    case "Top Rated":
      url = `${tmdbUrl}/movie/top_rated?api_key=${apiKey}`;
      break;
    default:
      // Using discover/movie with a query param fallback (this isn't perfect for genre names; it's a simple mapping)
      url = `${tmdbUrl}/discover/movie?api_key=${apiKey}&with_genres=${encodeURIComponent(category)}`;
      break;
  }
  const res = await fetchAPI(url);
  return res && res.results ? res.results : [];
}

async function loadCategory(cat) {
  // If embed mode and activeTab === movies -> use embed.su movie list; if tv -> embed.su tv list
  if (useEmbedAPI) {
    const url = activeTab === "movies" ? "https://embed.su/list/movie.json" : "https://embed.su/list/tv.json";
    const data = await fetchAPI(url);
    displayResults(data || []);
    renderCarousel((data && data.slice) ? data.slice(0, 6) : []);
    return;
  }

  // Not embed mode: use TMDB to fetch and display category
  const results = await fetchCategoryData(cat);
  displayResults(results);
  renderCarousel(results.slice(0, 6));
}

// -------------------- Home content loader (respects tab + toggle) --------------------
async function loadHomeContent() {
  bigDiv.innerHTML = "<p style='text-align:center;color:#9ca3af'>Loading...</p>";
  // If embed mode: load lists from embed.su per active tab
  if (useEmbedAPI) {
    const url = activeTab === "movies" ? "https://embed.su/list/movie.json" : "https://embed.su/list/tv.json";
    const data = await fetchAPI(url);
    displayResults(data || []);
    renderCarousel((data && data.slice) ? data.slice(0, 6) : []);
    return;
  }

  // Not embed mode: use TMDB popular endpoints per tab
  const url = activeTab === "movies" ? `${tmdbUrl}/movie/popular?api_key=${apiKey}` : `${tmdbUrl}/tv/popular?api_key=${apiKey}`;
  const res = await fetchAPI(url);
  if (!res) {
    bigDiv.innerHTML = "<p style='text-align:center;color:#9ca3af'>Failed to load content.</p>";
    return;
  }
  displayResults(res.results || []);
  renderCarousel((res.results || []).slice(0, 6));
}

// -------------------- Search (respects tab & toggle) --------------------
async function searchMedia(query) {
  if (!query) return;
  bigDiv.innerHTML = "<p style='text-align:center;color:#9ca3af'>Searching...</p>";

  if (useEmbedAPI) {
    // embed.su doesn't supply a search endpoint; fetch both lists (per active tab) and filter client side
    const url = activeTab === "movies" ? "https://embed.su/list/movie.json" : "https://embed.su/list/tv.json";
    const data = await fetchAPI(url);
    const items = data || [];
    const filtered = items.filter(i => {
      const title = (i.title || i.name || "").toLowerCase();
      return title.includes(query.toLowerCase());
    });
    displayResults(filtered);
    return;
  }

  // TMDB search
  const url = `${tmdbUrl}/search/${activeTab === "movies" ? "movie" : "tv"}?api_key=${apiKey}&query=${encodeURIComponent(query)}`;
  const res = await fetchAPI(url);
  if (!res) {
    bigDiv.innerHTML = "<p style='text-align:center;color:#9ca3af'>Search failed.</p>";
    return;
  }
  displayResults(res.results || []);
}

// -------------------- API Toggle handler --------------------
if (apiToggleEl) {
  apiToggleEl.addEventListener("change", (e) => {
    useEmbedAPI = e.target.checked;
    console.log(`Using ${useEmbedAPI ? "embed.su" : "original"} mode`);
    // reload content for the current tab
    loadHomeContent();
  });
}

// -------------------- Tabs handlers --------------------
moviesTab.addEventListener("click", () => {
  activeTab = "movies";
  moviesTab.classList.add("bg-blue-600");
  moviesTab.classList.remove("bg-gray-700");
  tvTab.classList.remove("bg-blue-600");
  tvTab.classList.add("bg-gray-700");
  loadHomeContent();
});

tvTab.addEventListener("click", () => {
  activeTab = "tv";
  tvTab.classList.add("bg-blue-600");
  tvTab.classList.remove("bg-gray-700");
  moviesTab.classList.remove("bg-blue-600");
  moviesTab.classList.add("bg-gray-700");
  loadHomeContent();
});

// -------------------- Settings Modal + Dark/Stealth --------------------
if (settingsButton) settingsButton.addEventListener("click", () => settingsModal.classList.remove("hidden"));

function closeSettingsModal() { settingsModal.classList.add("hidden"); }

if (darkToggle) {
  // initialize
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
    darkToggle.checked = true;
    darkLabel.textContent = "Dark Mode";
  } else darkLabel.textContent = "Light Mode";

  darkToggle.addEventListener("change", () => {
    document.documentElement.classList.toggle("dark", darkToggle.checked);
    darkLabel.textContent = darkToggle.checked ? "Dark Mode" : "Light Mode";
  });
}

// stealth behavior: open the site in an iframe in a new blank tab and then redirect current window (original code)
function triggerStealthMode() {
  if (window.location.href === "about:blank") return;
  const newTab = window.open("about:blank", "_blank");
  if (!newTab) return alert("Pop-up blocked!");
  newTab.document.write(`<html><body style="margin:0"><iframe src="${window.location.href}" style="width:100%;height:100%;border:none"></iframe></body></html>`);
  newTab.document.close();
  // original behavior redirected to google classroom in your file - keep it
  window.location.href = "https://classroom.google.com";
}
const stealthEnabled = localStorage.getItem(STEALTH_KEY) === 'true';
if (stealthToggle) {
  stealthToggle.checked = stealthEnabled;
  if (stealthToggle.checked) triggerStealthMode();
  stealthToggle.addEventListener("change", () => {
    localStorage.setItem(STEALTH_KEY, stealthToggle.checked);
    if (stealthToggle.checked) triggerStealthMode();
  });
}

// -------------------- Render History on load --------------------
renderHistory();

// -------------------- Search input handling --------------------
searchBar.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    const q = searchBar.value.trim();
    if (q) searchMedia(q);
  }
});

// -------------------- init --------------------
document.addEventListener("DOMContentLoaded", () => {
  // load initial home content
  loadHomeContent();

  // initial carousel rendering uses a TMDB trending fetch as example
  (async () => {
    if (!useEmbedAPI) {
      const data = await fetchAPI(`${tmdbUrl}/trending/all/day?api_key=${apiKey}`);
      if (data && data.results) renderCarousel(data.results.slice(0, 6));
    } else {
      const movies = await fetchAPI("https://embed.su/list/movie.json");
      renderCarousel((movies || []).slice(0, 6));
    }
  })();
});
