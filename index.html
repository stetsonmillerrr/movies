<script>
  lucide.createIcons();

  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPopup = document.getElementById('settingsPopup');
  const closeSettings = document.getElementById('closeSettings');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const fullscreenPrefToggle = document.getElementById('fullscreenPrefToggle');
  const openFullscreenNow = document.getElementById('openFullscreenNow');
  const resetSettings = document.getElementById('resetSettings');

  // Open/Close settings popup
  settingsBtn.addEventListener('click', () => {
    settingsPopup.classList.remove('hidden');
    lucide.createIcons(); // re-render icons inside popup
  });
  closeSettings.addEventListener('click', () => settingsPopup.classList.add('hidden'));

  // Load saved preferences
  const savedDarkMode = localStorage.getItem('darkMode') === 'true';
  const savedFullscreenPref = localStorage.getItem('fullscreenPref') === 'true';

  if (savedDarkMode) document.documentElement.classList.add('dark');
  darkModeToggle.checked = savedDarkMode;
  fullscreenPrefToggle.checked = savedFullscreenPref;

  // Dark mode toggle
  darkModeToggle.addEventListener('change', () => {
    const enabled = darkModeToggle.checked;
    if (enabled) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    localStorage.setItem('darkMode', enabled);
  });

  // Fullscreen preference toggle
  fullscreenPrefToggle.addEventListener('change', () => {
    localStorage.setItem('fullscreenPref', fullscreenPrefToggle.checked);
  });

  // Open in fullscreen now
  function openInFullscreen() {
    const win = window.open('about:blank', '_blank');
    if (!win) return;

    win.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Streaming Hub</title>
          <style>
            html,body{margin:0;height:100%;overflow:hidden;background:black;}
            iframe{border:none;width:100vw;height:100vh;display:block;}
          </style>
        </head>
        <body>
          <iframe src='${location.href}' allowfullscreen></iframe>
        </body>
      </html>
    `);
    win.document.close();

    // Request fullscreen after the new window loads
    win.onload = () => {
      win.document.documentElement.requestFullscreen?.();
    };
  }

  openFullscreenNow.addEventListener('click', openInFullscreen);

  // Auto-open if preference is set
  if (savedFullscreenPref) openInFullscreen();

  // Reset settings
  resetSettings.addEventListener('click', () => {
    localStorage.clear();
    darkModeToggle.checked = false;
    fullscreenPrefToggle.checked = false;
    document.documentElement.classList.remove('dark');
    alert('Settings reset successfully!');
  });
</script>
